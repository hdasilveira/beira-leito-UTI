<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Digital UTI - Registro de Pacientes</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style>
        /* Estilos existentes permanecem os mesmos at√© aqui */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            transition: background 0.3s, color 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        body.logged-in {
            display: block;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1e3c72 0%, #2c5aa0 100%);
            color: #f8f9fa;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: background 0.3s;
            display: none;
        }
        
        body.logged-in .container {
            display: block;
        }
        
        body.dark-mode .container {
            background: #2c3e50;
        }
        
        .login-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
        }
        
        body.dark-mode .login-container {
            background: #2c3e50;
        }
        
        .login-container h2 {
            margin-bottom: 20px;
            color: #2c5aa0;
        }
        
        body.dark-mode .login-container h2 {
            color: #a1b4d4;
        }
        
        .login-container input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
        
        body.dark-mode .login-container input {
            border-color: #2c3e50;
            background: #34495e;
            color: #f8f9fa;
        }
        
        .login-container button {
            background: linear-gradient(45deg, #2c5aa0, #1e3c72);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
        }
        
        .login-container button:hover {
            background: #1e3c72;
        }
        
        /* Resto dos estilos permanece o mesmo */
        .header {
            background: linear-gradient(45deg, #2c5aa0, #1e3c72);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        /* ... (outros estilos existentes permanecem iguais) ... */

        .increment-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .increment-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .increment-btn:hover {
            background: #138496;
        }
        
        .antibiotico-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .add-antibiotico-btn {
            background: #17a2b8;
            padding: 8px;
            font-size: 12px;
        }
        
        .add-antibiotico-btn:hover {
            background: #138496;
        }
        
        .remove-antibiotico-btn {
            background: #dc3545;
            padding: 8px;
            font-size: 12px;
        }
        
        .remove-antibiotico-btn:hover {
            background: #c82333;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .form-row, .dva-row {
                grid-template-columns: 1fr;
            }
            
            .vitals-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Usu√°rio" required>
        <input type="password" id="password" placeholder="Senha" required>
        <button onclick="login()">Entrar</button>
        <button onclick="register()">Registrar Novo Usu√°rio</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>üè• Sistema Digital UTI - beira-leito</h1>
        </div>
        
        <div class="date-section">
            <label for="reportDate">Data do Plant√£o:</label>
            <input type="date" id="reportDate" class="date-input">
        </div>
        
        <div class="content">
            <button id="darkModeToggle" class="btn" onclick="toggleDarkMode()">üåô Modo Escuro</button>
            <button class="btn" onclick="addPatient()">‚ûï Adicionar Paciente</button>

            <div id="tabBar" class="tab-bar"></div>
            
            <div id="patientsContainer"></div>
            <div id="calculadoras"></div>
            
            <button class="btn btn-success" onclick="generateReport()">üìã Gerar Relat√≥rio Final</button>
            
            <div id="reportSection" class="report-section">
                <h3>üìÑ Relat√≥rio do Plant√£o</h3>
                <div id="reportContent" class="report-content"></div>
                <button class="btn copy-btn" onclick="copyReport()">üìã Copiar Relat√≥rio</button>
            </div>
            
            <button id="resetAll" class="btn" onclick="resetAllData()">üóëÔ∏è Resetar Tudo</button>
        </div>

        <div class="footer">
            <p>Criado por Henrique Ceron</p>
        </div>
    </div>

    <script>
        let patientCounter = 0;
        let currentTab = 'pacientes';
        let currentPatientId = null;
        let dvaCounters = {};
        let antibioticoCounters = {};
        let isLoggedIn = false;

        // Fun√ß√£o de hash simples (n√£o use em produ√ß√£o sem salting)
        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Converte para 32 bits
            }
            return hash.toString();
        }

        // Verificar login
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const hashedPassword = hashPassword(password);

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[username] && users[username] === hashedPassword) {
                isLoggedIn = true;
                document.body.classList.add('logged-in');
                document.getElementById('loginContainer').style.display = 'none';
                loadData();
            } else {
                alert('Usu√°rio ou senha inv√°lidos!');
            }
        }

        // Registrar novo usu√°rio
        function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (!username || !password) {
                alert('Preencha usu√°rio e senha!');
                return;
            }

            let users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[username]) {
                alert('Usu√°rio j√° existe!');
                return;
            }

            users[username] = hashPassword(password);
            localStorage.setItem('users', JSON.stringify(users));
            alert('Usu√°rio registrado com sucesso! Fa√ßa login.');
        }

        // Verificar login ao carregar
        window.addEventListener('load', () => {
            if (!isLoggedIn) {
                document.body.classList.remove('logged-in');
                document.getElementById('loginContainer').style.display = 'block';
            } else {
                loadData();
            }
        });

        // Fun√ß√µes existentes
        function addPatient() {
            if (!isLoggedIn) return;
            patientCounter++;
            dvaCounters[patientCounter] = 0;
            antibioticoCounters[patientCounter] = 0;
            const patientHtml = `
                <div class="patient-card" data-patient-id="${patientCounter}">
                    <div class="patient-header">
                        <span class="patient-title">Paciente ${patientCounter}</span>
                        <button class="delete-btn" onclick="deletePatient(${patientCounter})">üóëÔ∏è Excluir</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Leito:</label>
                            <input type="text" id="leito_${patientCounter}" placeholder="Ex: 01" oninput="updateTabs(); saveData();">
                        </div>
                        <div class="form-group">
                            <label>Nome:</label>
                            <input type="text" id="nome_${patientCounter}" placeholder="Nome do paciente" oninput="saveData();">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Sinais Vitais:</label>
                        <div class="vitals-grid">
                            <input type="text" id="pa_${patientCounter}" placeholder="P.A." oninput="validateInput(this, 'text'); saveData();">
                            <input type="text" id="fc_${patientCounter}" placeholder="FC" oninput="validateInput(this, 'decimal'); saveData();">
                            <input type="text" id="fr_${patientCounter}" placeholder="FR" oninput="validateInput(this, 'decimal'); saveData();">
                            <input type="text" id="pam_${patientCounter}" placeholder="PAM" oninput="validateInput(this, 'decimal'); saveData();">
                            <input type="text" id="tax_${patientCounter}" placeholder="T. Axilar" oninput="validateInput(this, 'decimal'); saveData();">
                        </div>
                        <div style="margin-top: 10px;">
                            <input type="text" id="spo2_${patientCounter}" placeholder="SpO‚ÇÇ" oninput="validateInput(this, 'decimal'); saveData();">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Controles por Hor√°rio:</label>
                        <div class="checkbox-item" style="margin-bottom: 10px;">
                            <input type="checkbox" id="enable_pa_${patientCounter}" onclick="togglePaControls(${patientCounter}); saveData();">
                            <label for="enable_pa_${patientCounter}">Ativar controle de PA por hor√°rio</label>
                        </div>
                        <table class="time-table">
                            <tr>
                                <th>Par√¢m.</th>
                                <th>20h</th>
                                <th>22h</th>
                                <th>00h</th>
                                <th>02h</th>
                                <th>04h</th>
                                <th>06h</th>
                            </tr>
                            <tr id="pa_row_${patientCounter}" style="display: none;">
                                <td><strong>PA</strong></td>
                                <td><input type="text" id="pa_20_${patientCounter}" oninput="validateInput(this, 'text'); saveData();"></td>
                                <td><input type="text" id="pa_22_${patientCounter}" oninput="validateInput(this, 'text'); saveData();"></td>
                                <td><input type="text" id="pa_00_${patientCounter}" oninput="validateInput(this, 'text'); saveData();"></td>
                                <td><input type="text" id="pa_02_${patientCounter}" oninput="validateInput(this, 'text'); saveData();"></td>
                                <td><input type="text" id="pa_04_${patientCounter}" oninput="validateInput(this, 'text'); saveData();"></td>
                                <td><input type="text" id="pa_06_${patientCounter}" oninput="validateInput(this, 'text'); saveData();"></td>
                            </tr>
                            <tr>
                                <td><strong>HGT</strong></td>
                                <td><input type="text" id="hgt_20_${patientCounter}" oninput="validateInput(this, 'decimal'); calculateDeltaHGT(${patientCounter}); saveData();"></td>
                                <td><input type="text" id="hgt_22_${patientCounter}" oninput="validateInput(this, 'decimal'); calculateDeltaHGT(${patientCounter}); saveData();"></td>
                                <td><input type="text" id="hgt_00_${patientCounter}" oninput="validateInput(this, 'decimal'); calculateDeltaHGT(${patientCounter}); saveData();"></td>
                                <td><input type="text" id="hgt_02_${patientCounter}" oninput="validateInput(this, 'decimal'); calculateDeltaHGT(${patientCounter}); saveData();"></td>
                                <td><input type="text" id="hgt_04_${patientCounter}" oninput="validateInput(this, 'decimal'); calculateDeltaHGT(${patientCounter}); saveData();"></td>
                                <td><input type="text" id="hgt_06_${patientCounter}" oninput="validateInput(this, 'decimal'); calculateDeltaHGT(${patientCounter}); saveData();"></td>
                            </tr>
                            <tr>
                                <td><strong>TA</strong></td>
                                <td><input type="text" id="ta_20_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();"></td>
                                <td><input type="text" id="ta_22_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();"></td>
                                <td><input type="text" id="ta_00_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();"></td>
                                <td><input type="text" id="ta_02_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();"></td>
                                <td><input type="text" id="ta_04_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();"></td>
                                <td><input type="text" id="ta_06_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();"></td>
                            </tr>
                        </table>
                        <div style="text-align: center; margin-top: 5px;">
                            <input type="text" id="delta_hgt_${patientCounter}" placeholder="Delta-HGT ser√° calculado automaticamente" readonly style="background-color: #e9ecef; font-weight: bold; color: #495057;">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fluidos (ml):</label>
                            <input type="text" id="fluidos_${patientCounter}" placeholder="Ex: 200+500+700" oninput="calculateBalance(${patientCounter}); saveData();">
                            <div class="increment-buttons" id="fluidos_buttons_${patientCounter}">
                                <button class="increment-btn" onclick="addToField('fluidos', ${patientCounter}, 5)">+5</button>
                                <button class="increment-btn" onclick="addToField('fluidos', ${patientCounter}, 10)">+10</button>
                                <button class="increment-btn" onclick="addToField('fluidos', ${patientCounter}, 50)">+50</button>
                                <button class="increment-btn" onclick="addToField('fluidos', ${patientCounter}, 100)">+100</button>
                                <button class="increment-btn" onclick="addToField('fluidos', ${patientCounter}, 200)">+200</button>
                                <button class="increment-btn" onclick="addToField('fluidos', ${patientCounter}, 500)">+500</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Outros fluidos administrados (ml):</label>
                            <input type="text" id="outros_${patientCounter}" placeholder="Ex: 50+100 (gotejos, etc.)" oninput="calculateBalance(${patientCounter}); saveData();">
                            <div class="increment-buttons" id="outros_buttons_${patientCounter}">
                                <button class="increment-btn" onclick="addToField('outros', ${patientCounter}, 5)">+5</button>
                                <button class="increment-btn" onclick="addToField('outros', ${patientCounter}, 10)">+10</button>
                                <button class="increment-btn" onclick="addToField('outros', ${patientCounter}, 50)">+50</button>
                                <button class="increment-btn" onclick="addToField('outros', ${patientCounter}, 100)">+100</button>
                                <button class="increment-btn" onclick="addToField('outros', ${patientCounter}, 200)">+200</button>
                                <button class="increment-btn" onclick="addToField('outros', ${patientCounter}, 500)">+500</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Diurese (ml):</label>
                            <input type="text" id="diurese_${patientCounter}" placeholder="Ex: 100+200+300" oninput="calculateBalance(${patientCounter}); saveData();">
                            <div class="increment-buttons" id="diurese_buttons_${patientCounter}">
                                <button class="increment-btn" onclick="addToField('diurese', ${patientCounter}, 5)">+5</button>
                                <button class="increment-btn" onclick="addToField('diurese', ${patientCounter}, 10)">+10</button>
                                <button class="increment-btn" onclick="addToField('diurese', ${patientCounter}, 50)">+50</button>
                                <button class="increment-btn" onclick="addToField('diurese', ${patientCounter}, 100)">+100</button>
                                <button class="increment-btn" onclick="addToField('diurese', ${patientCounter}, 200)">+200</button>
                                <button class="increment-btn" onclick="addToField('diurese', ${patientCounter}, 500)">+500</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Diurese em bolsa (ml):</label>
                            <input type="text" id="diurese_bolsa_${patientCounter}" placeholder="Ex: 150+250 (n√£o contabiliza no balan√ßo)" oninput="saveData();">
                        </div>
                        <div class="form-group">
                            <label>Total (ml):</label>
                            <input type="text" id="total_${patientCounter}" readonly style="background-color: #e9ecef; font-weight: bold; color: #495057;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Evacua√ß√µes:</label>
                        <input type="text" id="evacuacoes_${patientCounter}" placeholder="Descri√ß√£o das evacua√ß√µes" oninput="saveData();">
                    </div>
                    
                    <div class="form-group">
                        <label>Antibioticoterapia:</label>
                        <div class="antibiotico-container" id="antibiotico_container_${patientCounter}">
                            <div class="form-row antibiotico-row" data-antibiotico-id="0">
                                <input type="text" id="antibiotico_nome_0_${patientCounter}" placeholder="Nome do antibi√≥tico" oninput="saveData();">
                                <input type="text" id="antibiotico_dia_0_${patientCounter}" placeholder="Dia de uso (ex: d1, d2)" oninput="saveData();">
                                <button class="btn remove-antibiotico-btn" style="display: none;" onclick="removeAntibiotico(${patientCounter}, 0)">üóëÔ∏è</button>
                            </div>
                        </div>
                        <button class="btn add-antibiotico-btn" onclick="addAntibiotico(${patientCounter})">‚ûï Adicionar Antibi√≥tico</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Dispositivos em Uso:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="cvc_${patientCounter}" onclick="toggleDeviceDetails('cvc', ${patientCounter}); saveData();">
                                <label for="cvc_${patientCounter}">CVC</label>
                                <div id="cvc_details_${patientCounter}" class="device-details">
                                    <select id="cvc_side_${patientCounter}" onchange="saveData();">
                                        <option value="">Lado</option>
                                        <option value="D">D</option>
                                        <option value="E">E</option>
                                    </select>
                                    <input type="text" id="cvc_local_${patientCounter}" placeholder="Local exato" oninput="saveData();">
                                </div>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="avp_${patientCounter}" onclick="toggleDeviceDetails('avp', ${patientCounter}); saveData();">
                                <label for="avp_${patientCounter}">AVP</label>
                                <div id="avp_details_${patientCounter}" class="device-details">
                                    <select id="avp_side_${patientCounter}" onchange="saveData();">
                                        <option value="">Lado</option>
                                        <option value="D">D</option>
                                        <option value="E">E</option>
                                    </select>
                                    <input type="text" id="avp_local_${patientCounter}" placeholder="Local exato" oninput="saveData();">
                                </div>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="linha_arterial_${patientCounter}" onclick="toggleDeviceDetails('linha_arterial', ${patientCounter}); saveData();">
                                <label for="linha_arterial_${patientCounter}">Linha Arterial (PAM)</label>
                                <div id="linha_arterial_details_${patientCounter}" class="device-details">
                                    <select id="linha_arterial_side_${patientCounter}" onchange="saveData();">
                                        <option value="">Lado</option>
                                        <option value="D">D</option>
                                        <option value="E">E</option>
                                    </select>
                                    <input type="text" id="linha_arterial_local_${patientCounter}" placeholder="Local exato" oninput="saveData();">
                                </div>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="svd_${patientCounter}" onclick="saveData();">
                                <label for="svd_${patientCounter}">SVD</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="tot_${patientCounter}" onclick="saveData();">
                                <label for="tot_${patientCounter}">TOT/Traq</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="sng_${patientCounter}" onclick="saveData();">
                                <label for="sng_${patientCounter}">SNG/SNE</label>
                            </div>
                        </div>
                        <div class="dva-container" id="dva_container_${patientCounter}">
                            <div class="dva-row" data-dva-id="0">
                                <input type="text" id="dva_nome_0_${patientCounter}" placeholder="Droga vasoativa" oninput="saveData();">
                                <input type="text" id="dva_dose_0_${patientCounter}" placeholder="Dose (ex: mcg/kg/min)" oninput="saveData();">
                                <button class="btn remove-dva-btn" style="display: none;" onclick="removeDva(${patientCounter}, 0)">üóëÔ∏è</button>
                            </div>
                        </div>
                        <button class="btn add-dva-btn" onclick="addDva(${patientCounter})">‚ûï Adicionar Droga Vasoativa</button>
                        <div style="margin-top: 10px;">
                            <input type="text" id="drenos_${patientCounter}" placeholder="Drenos (especificar)" oninput="saveData();">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Observa√ß√µes:</label>
                        <textarea id="observacoes_${patientCounter}" rows="3" placeholder="Observa√ß√µes importantes do plant√£o..." oninput="saveData();"></textarea>
                    </div>
                    <button class="btn" onclick="toggleSOFA(${patientCounter})">Calcular SOFA</button>
                    <div class="form-group" id="sofa_section_${patientCounter}" style="display: none;">
                        <label>Score SOFA:</label>
                        <div class="calc-content">
                            <div class="form-group">
                                <label>Respira√ß√£o (PaO2/FiO2):</label>
                                <input type="text" id="sofa_resp_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();">
                            </div>
                            <div class="form-group">
                                <label>Plaquetas (x10^3/¬µL):</label>
                                <input type="text" id="sofa_plat_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();">
                            </div>
                            <div class="form-group">
                                <label>Bilirrubina (mg/dL):</label>
                                <input type="text" id="sofa_bili_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();">
                            </div>
                            <div class="form-group">
                                <label>Cardiovascular (MAP ou Vasoativos):</label>
                                <input type="text" id="sofa_cv_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();">
                            </div>
                            <div class="form-group">
                                <label>Glasgow (SNC):</label>
                                <input type="text" id="sofa_gcs_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();">
                            </div>
                            <div class="form-group">
                                <label>Creatinina (mg/dL) ou Diurese (mL/dia):</label>
                                <input type="text" id="sofa_renal_${patientCounter}" oninput="validateInput(this, 'decimal'); saveData();">
                            </div>
                            <button type="button" class="btn" onclick="calcSOFA(${patientCounter})">Calcular SOFA</button>
                            <p id="sofaResult_${patientCounter}"></p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('patientsContainer').insertAdjacentHTML('beforeend', patientHtml);
            showTab('pacientes', patientCounter);
            updatePatientDisplays();
            saveData();
        }
        
        function addDva(patientId) {
            if (!isLoggedIn) return;
            dvaCounters[patientId] = (dvaCounters[patientId] || 0) + 1;
            const dvaIndex = dvaCounters[patientId];
            const dvaHtml = `
                <div class="dva-row" data-dva-id="${dvaIndex}">
                    <input type="text" id="dva_nome_${dvaIndex}_${patientId}" placeholder="Droga vasoativa" oninput="saveData();">
                    <input type="text" id="dva_dose_${dvaIndex}_${patientId}" placeholder="Dose (ex: mcg/kg/min)" oninput="saveData();">
                    <button class="btn remove-dva-btn" onclick="removeDva(${patientId}, ${dvaIndex})">üóëÔ∏è</button>
                </div>
            `;
            const container = document.getElementById(`dva_container_${patientId}`);
            if (container) {
                container.insertAdjacentHTML('beforeend', dvaHtml);
                saveData();
            }
        }
        
        function removeDva(patientId, dvaIndex) {
            if (!isLoggedIn) return;
            const row = document.querySelector(`#dva_container_${patientId} [data-dva-id="${dvaIndex}"]`);
            if (row) {
                row.remove();
                saveData();
            }
        }
        
        function addAntibiotico(patientId) {
            if (!isLoggedIn) return;
            antibioticoCounters[patientId] = (antibioticoCounters[patientId] || 0) + 1;
            const index = antibioticoCounters[patientId];
            const html = `
                <div class="form-row antibiotico-row" data-antibiotico-id="${index}">
                    <input type="text" id="antibiotico_nome_${index}_${patientId}" placeholder="Nome do antibi√≥tico" oninput="saveData();">
                    <input type="text" id="antibiotico_dia_${index}_${patientId}" placeholder="Dia de uso (ex: d1, d2)" oninput="saveData();">
                    <button class="btn remove-antibiotico-btn" onclick="removeAntibiotico(${patientId}, ${index})">üóëÔ∏è</button>
                </div>
            `;
            const container = document.getElementById(`antibiotico_container_${patientId}`);
            if (container) {
                container.insertAdjacentHTML('beforeend', html);
                saveData();
            }
        }
        
        function removeAntibiotico(patientId, index) {
            if (!isLoggedIn) return;
            const row = document.querySelector(`#antibiotico_container_${patientId} [data-antibiotico-id="${index}"]`);
            if (row) {
                row.remove();
                saveData();
            }
        }
        
        function deletePatient(patientId) {
            if (!isLoggedIn) return;
            const patientCard = document.querySelector(`[data-patient-id="${patientId}"]`);
            if (patientCard) {
                patientCard.remove();
                delete dvaCounters[patientId];
                delete antibioticoCounters[patientId];
            }
            if (currentTab === 'pacientes' && currentPatientId === patientId) {
                const remainingCards = document.querySelectorAll('.patient-card');
                if (remainingCards.length > 0) {
                    showTab('pacientes', parseInt(remainingCards[0].dataset.patientId));
                } else {
                    showTab('pacientes');
                }
            }
            updatePatientDisplays();
            saveData();
        }
        
        function updatePatientDisplays() {
            if (!isLoggedIn) return;
            const cards = document.querySelectorAll('.patient-card');
            cards.forEach((card, index) => {
                const title = card.querySelector('.patient-title');
                if (title) {
                    title.textContent = `Paciente ${index + 1}`;
                }
            });
            updateTabs();
        }

        function updateTabs() {
            if (!isLoggedIn) return;
            const tabBar = document.getElementById('tabBar');
            tabBar.innerHTML = '';
            
            const calcBtn = document.createElement('button');
            calcBtn.className = 'tab-btn';
            calcBtn.textContent = 'üßÆ Calculadoras';
            calcBtn.onclick = () => showTab('calculadoras');
            if (currentTab === 'calculadoras') {
                calcBtn.classList.add('active');
            }
            tabBar.appendChild(calcBtn);
            
            const cards = document.querySelectorAll('.patient-card');
            cards.forEach((card, index) => {
                const id = parseInt(card.dataset.patientId);
                const leito = getValue(`leito_${id}`);
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.textContent = `P${index + 1}${leito ? ' - L' + leito : ''}`;
                btn.onclick = () => showTab('pacientes', id);
                if (currentTab === 'pacientes' && id === currentPatientId) {
                    btn.classList.add('active');
                }
                tabBar.appendChild(btn);
            });
        }

        function showTab(tab, patientId = null) {
            if (!isLoggedIn) return;
            document.querySelectorAll('.patient-card').forEach(card => card.style.display = 'none');
            document.getElementById('calculadoras').style.display = 'none';
            
            if (tab === 'pacientes') {
                currentTab = 'pacientes';
                if (patientId) {
                    const patientCard = document.querySelector(`[data-patient-id="${patientId}"]`);
                    if (patientCard) {
                        patientCard.style.display = 'block';
                    }
                    currentPatientId = patientId;
                } else if (document.querySelectorAll('.patient-card').length > 0) {
                    showTab('pacientes', parseInt(document.querySelector('.patient-card').dataset.patientId));
                    return;
                }
            } else if (tab === 'calculadoras') {
                currentTab = 'calculadoras';
                document.getElementById('calculadoras').style.display = 'block';
            }
            updateTabs();
        }
        
        function getValue(id) {
            if (!isLoggedIn) return '';
            const element = document.getElementById(id);
            if (!element) return '';
            
            if (element.type === 'checkbox') {
                return element.checked;
            }
            return element.value || '';
        }

        function sumExpression(str) {
            if (!str) return 0;
            return str.split('+').reduce((acc, val) => acc + (parseFloat(val.trim().replace(',', '.')) || 0), 0);
        }
        
        function calculateBalance(patientId) {
            if (!isLoggedIn) return;
            const fluidos = sumExpression(getValue(`fluidos_${patientId}`));
            const outros = sumExpression(getValue(`outros_${patientId}`));
            const diurese = sumExpression(getValue(`diurese_${patientId}`));
            
            const total = fluidos + outros - diurese;
            
            const totalField = document.getElementById(`total_${patientId}`);
            if (totalField) {
                totalField.value = total.toFixed(2);
                
                if (total > 0) {
                    totalField.style.color = '#28a745';
                } else if (total < 0) {
                    totalField.style.color = '#dc3545';
                } else {
                    totalField.style.color = '#6c757d';
                }
            }
        }
        
        function calculateDeltaHGT(patientId) {
            if (!isLoggedIn) return;
            const horarios = ['20', '22', '00', '02', '04', '06'];
            const valores = [];
            
            horarios.forEach(h => {
                const valor = parseFloat(getValue(`hgt_${h}_${patientId}`).replace(',', '.'));
                if (!isNaN(valor) && valor > 0) {
                    valores.push(valor);
                }
            });
            
            const deltaField = document.getElementById(`delta_hgt_${patientId}`);
            
            if (valores.length >= 2) {
                const maior = Math.max(...valores);
                const menor = Math.min(...valores);
                deltaField.value = `(${menor.toFixed(2)} - ${maior.toFixed(2)})`;
                
                const diferenca = maior - menor;
                if (diferenca > 50) {
                    deltaField.style.color = '#dc3545';
                } else if (diferenca > 30) {
                    deltaField.style.color = '#ffc107';
                } else {
                    deltaField.style.color = '#28a745';
                }
            } else if (valores.length === 1) {
                deltaField.value = `(${valores[0].toFixed(2)} - aguardando mais valores)`;
                deltaField.style.color = '#6c757d';
            } else {
                deltaField.value = '';
                deltaField.style.color = '#495057';
            }
        }
        
        function togglePaControls(patientId) {
            if (!isLoggedIn) return;
            const row = document.getElementById(`pa_row_${patientId}`);
            const checkbox = document.getElementById(`enable_pa_${patientId}`);
            if (row && checkbox) {
                row.style.display = checkbox.checked ? 'table-row' : 'none';
            }
        }

        function toggleDeviceDetails(device, patientId) {
            if (!isLoggedIn) return;
            const checkbox = document.getElementById(`${device}_${patientId}`);
            const details = document.getElementById(`${device}_details_${patientId}`);
            if (details && checkbox) {
                details.style.display = checkbox.checked ? 'flex' : 'none';
            }
        }
        
        function addToField(field, patientId, value) {
            if (!isLoggedIn) return;
            const input = document.getElementById(`${field}_${patientId}`);
            if (input) {
                if (input.value) {
                    input.value += `+${value}`;
                } else {
                    input.value = `${value}`;
                }
                calculateBalance(patientId);
                saveData();
            }
        }
        
        function toggleSOFA(patientId) {
            if (!isLoggedIn) return;
            const section = document.getElementById(`sofa_section_${patientId}`);
            if (section) {
                section.style.display = section.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function validateInput(input, type) {
            if (!isLoggedIn) return;
            if (type === 'decimal') {
                input.value = input.value.replace(/[^0-9,.]/g, '');
                input.value = input.value.replace(',', '.');
                const parts = input.value.split('.');
                if (parts.length > 2) {
                    input.value = parts[0] + '.' + parts[1];
                }
                if (parseFloat(input.value) < 0) {
                    alert('Valor n√£o pode ser negativo!');
                    input.value = '';
                }
            }
        }
        
        function generateReport() {
            if (!isLoggedIn) return;
            const reportDate = document.getElementById('reportDate').value;
            const patientCards = document.querySelectorAll('.patient-card');
            
            if (patientCards.length === 0) {
                alert('‚ö†Ô∏è Adicione pelo menos um paciente para gerar o relat√≥rio!');
                return;
            }
            
            let report = `üè• RELAT√ìRIO UTI - ${formatDate(reportDate)}\n`;
            report += `${'='.repeat(50)}\n\n`;
            
            patientCards.forEach((card) => {
                const patientId = card.getAttribute('data-patient-id');
                const leito = getValue(`leito_${patientId}`);
                const nome = getValue(`nome_${patientId}`);
                
                if (!leito && !nome) return;
                
                report += `üë§ PACIENTE - LEITO ${leito || 'N/I'}\n`;
                report += `Nome: ${nome || 'N√£o informado'}\n`;
                report += `${'-'.repeat(30)}\n`;
                
                const pa = getValue(`pa_${patientId}`);
                const fc = getValue(`fc_${patientId}`);
                const fr = getValue(`fr_${patientId}`);
                const pam = getValue(`pam_${patientId}`);
                const tax = getValue(`tax_${patientId}`);
                const spo2 = getValue(`spo2_${patientId}`);
                
                if (pa || fc || fr || pam || tax || spo2) {
                    report += `üìä SINAIS VITAIS:\n`;
                    if (pa) report += `‚Ä¢ P.A.: ${pa}\n`;
                    if (fc) report += `‚Ä¢ FC: ${fc}\n`;
                    if (fr) report += `‚Ä¢ FR: ${fr}\n`;
                    if (pam) report += `‚Ä¢ PAM: ${pam}\n`;
                    if (tax) report += `‚Ä¢ T. Axilar: ${tax}\n`;
                    if (spo2) report += `‚Ä¢ SpO‚ÇÇ: ${spo2}\n`;
                    report += `\n`;
                }
                
                const horarios = ['20', '22', '00', '02', '04', '06'];
                let temControles = false;
                
                report += `‚è∞ CONTROLES POR HOR√ÅRIO:\n`;
                
                if (getValue(`enable_pa_${patientId}`)) {
                    let paValues = horarios.map(h => getValue(`pa_${h}_${patientId}`)).filter(v => v);
                    if (paValues.length > 0) {
                        report += `‚Ä¢ PA: `;
                        horarios.forEach(h => {
                            const valor = getValue(`pa_${h}_${patientId}`);
                            if (valor) report += `${h}h:${valor} `;
                        });
                        report += `\n`;
                        temControles = true;
                    }
                }
                
                let hgtValues = horarios.map(h => getValue(`hgt_${h}_${patientId}`)).filter(v => v);
                if (hgtValues.length > 0) {
                    report += `‚Ä¢ HGT: `;
                    horarios.forEach(h => {
                        const valor = getValue(`hgt_${h}_${patientId}`);
                        if (valor) report += `${h}h:${valor} `;
                    });
                    report += `\n`;
                    temControles = true;
                }
                
                let taValues = horarios.map(h => getValue(`ta_${h}_${patientId}`)).filter(v => v);
                if (taValues.length > 0) {
                    report += `‚Ä¢ TA: `;
                    horarios.forEach(h => {
                        const valor = getValue(`ta_${h}_${patientId}`);
                        if (valor) report += `${h}h:${valor} `;
                    });
                    report += `\n`;
                    temControles = true;
                }
                
                const deltaHgt = getValue(`delta_hgt_${patientId}`);
                if (deltaHgt) {
                    report += `‚Ä¢ Delta-HGT: ${deltaHgt}\n`;
                    temControles = true;
                }
                
                if (!temControles) {
                    report += `Nenhum controle registrado\n`;
                }
                report += `\n`;
                
                const fluidosStr = getValue(`fluidos_${patientId}`);
                const fluidosSum = sumExpression(fluidosStr);
                const outrosStr = getValue(`outros_${patientId}`);
                const outrosSum = sumExpression(outrosStr);
                const diureseStr = getValue(`diurese_${patientId}`);
                const diureseSum = sumExpression(diureseStr);
                const diureseBolsaStr = getValue(`diurese_bolsa_${patientId}`);
                const diureseBolsaSum = sumExpression(diureseBolsaStr);
                const total = getValue(`total_${patientId}`);
                
                if (fluidosStr || outrosStr || diureseStr || diureseBolsaStr || total) {
                    report += `üíß BALAN√áO H√çDRICO (24h):\n`;
                    if (fluidosStr) report += `‚Ä¢ Fluidos: ${fluidosStr.includes('+') ? fluidosStr + ' = ' : ''}${fluidosSum.toFixed(2)}ml\n`;
                    if (outrosStr) report += `‚Ä¢ Outros fluidos administrados: ${outrosStr.includes('+') ? outrosStr + ' = ' : ''}${outrosSum.toFixed(2)}ml\n`;
                    if (diureseStr) report += `‚Ä¢ Diurese: ${diureseStr.includes('+') ? diureseStr + ' = ' : ''}${diureseSum.toFixed(2)}ml\n`;
                    if (diureseBolsaStr) report += `‚Ä¢ Diurese em bolsa: ${diureseBolsaStr.includes('+') ? diureseBolsaStr + ' = ' : ''}${diureseBolsaSum.toFixed(2)}ml\n`;
                    if (total) report += `‚Ä¢ Total: ${total}ml\n`;
                    report += `\n`;
                }
                
                const antibioticos = [];
                const antibioticoContainer = document.getElementById(`antibiotico_container_${patientId}`);
                if (antibioticoContainer) {
                    antibioticoContainer.querySelectorAll('.antibiotico-row').forEach(row => {
                        const index = row.dataset.antibioticoId || 0;
                        const nome = getValue(`antibiotico_nome_${index}_${patientId}`);
                        const dia = getValue(`antibiotico_dia_${index}_${patientId}`);
                        if (nome || dia) {
                            antibioticos.push(`${nome || 'Antibi√≥tico n√£o especificado'}${dia ? ` - ${dia}` : ''}`);
                        }
                    });
                }
                if (antibioticos.length > 0) {
                    report += `üíä ANTIBIOTICOTERAPIA:\n`;
                    antibioticos.forEach(ab => report += `‚Ä¢ ${ab}\n`);
                    report += `\n`;
                }
                
                const evacuacoes = getValue(`evacuacoes_${patientId}`);
                if (evacuacoes) {
                    report += `üöΩ ELIMINA√á√ïES:\n`;
                    report += `‚Ä¢ Evacua√ß√µes: ${evacuacoes}\n\n`;
                }
                
                const dispositivos = [];
                if (getValue(`cvc_${patientId}`)) {
                    const cvcSide = getValue(`cvc_side_${patientId}`);
                    const cvcLocal = getValue(`cvc_local_${patientId}`);
                    dispositivos.push(`CVC${cvcSide ? ` (${cvcSide})` : ''}${cvcSide ? ` - ${cvcLocal}` : ''}`);
                }
                if (getValue(`avp_${patientId}`)) {
                    const avpSide = getValue(`avp_side_${patientId}`);
                    const avpLocal = getValue(`avp_local_${patientId}`);
                    dispositivos.push(`AVP${avpSide ? ` (${avpSide})` : ''}${avpLocal ? ` - ${avpLocal}` : ''}`);
                }
                if (getValue(`linha_arterial_${patientId}`)) {
                    const laSide = getValue(`linha_arterial_side_${patientId}`);
                    const laLocal = getValue(`linha_arterial_local_${patientId}`);
                    dispositivos.push(`Linha Arterial (PAM)${laSide ? ` (${laSide})` : ''}${laLocal ? ` - ${laLocal}` : ''}`);
                }
                if (getValue(`svd_${patientId}`)) dispositivos.push('SVD');
                if (getValue(`tot_${patientId}`)) dispositivos.push('TOT/Traq');
                if (getValue(`sng_${patientId}`)) dispositivos.push('SNG/SNE');
                
                const drenos = getValue(`drenos_${patientId}`);
                if (drenos) dispositivos.push(`Drenos: ${drenos}`);
                
                const dvas = [];
                const dvaContainer = document.getElementById(`dva_container_${patientId}`);
                if (dvaContainer) {
                    dvaContainer.querySelectorAll('.dva-row').forEach(row => {
                        const index = row.dataset.dvaId || 0;
                        const nome = getValue(`dva_nome_${index}_${patientId}`);
                        const dose = getValue(`dva_dose_${index}_${patientId}`);
                        if (nome || dose) {
                            dvas.push(`${nome || 'DVA n√£o especificada'}${dose ? ` (${dose})` : ''}`);
                        }
                    });
                }
                if (dvas.length > 0) {
                    dispositivos.push(...dvas.map(dva => `DVA: ${dva}`));
                }
                
                if (dispositivos.length > 0) {
                    report += `üîß DISPOSITIVOS EM USO:\n`;
                    dispositivos.forEach(disp => report += `‚Ä¢ ${disp}\n`);
                    report += `\n`;
                }

                const sofaResult = document.getElementById(`sofaResult_${patientId}`)?.innerText || '';
                if (sofaResult) {
                    report += `üìä SCORE SOFA:\n`;
                    report += `${sofaResult}\n\n`;
                }
                
                const observacoes = getValue(`observacoes_${patientId}`);
                if (observacoes) {
                    report += `üìù OBSERVA√á√ïES:\n`;
                    report += `${observacoes}\n\n`;
                }
                
                report += `${'='.repeat(50)}\n\n`;
            });
            
            report += `üìÖ Relat√≥rio gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
            
            document.getElementById('reportContent').textContent = report;
            document.getElementById('reportSection').style.display = 'block';
            document.getElementById('reportSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function copyReport() {
            if (!isLoggedIn) return;
            const reportContent = document.getElementById('reportContent').textContent;
            navigator.clipboard.writeText(reportContent).then(() => {
                alert('‚úÖ Relat√≥rio copiado para a √°rea de transfer√™ncia!');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = reportContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ Relat√≥rio copiado para a √°rea de transfer√™ncia!');
            });
        }
        
        function formatDate(dateString) {
            if (!dateString) return new Date().toLocaleDateString('pt-BR');
            return new Date(dateString + 'T12:00:00').toLocaleDateString('pt-BR');
        }
        
        function saveData() {
            if (!isLoggedIn) return;
            const data = {
                reportDate: document.getElementById('reportDate').value,
                patients: [],
                patientCounter: patientCounter,
                dvaCounters: dvaCounters,
                antibioticoCounters: antibioticoCounters,
                darkMode: document.body.classList.contains('dark-mode')
            };
            
            document.querySelectorAll('.patient-card').forEach(card => {
                const id = card.dataset.patientId;
                const patientData = {};
                const inputs = card.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.id) {
                        if (input.type === 'checkbox') {
                            patientData[input.id] = input.checked;
                        } else {
                            patientData[input.id] = input.value;
                        }
                    }
                });
                data.patients.push({id: id, data: patientData});
            });
            
            localStorage.setItem('utiData', JSON.stringify(data));
        }
        
        function loadData() {
            if (!isLoggedIn) return;
            const savedData = localStorage.getItem('utiData');
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('reportDate').value = data.reportDate;
                patientCounter = data.patientCounter || 0;
                dvaCounters = data.dvaCounters || {};
                antibioticoCounters = data.antibioticoCounters || {};
                
                data.patients.forEach(patient => {
                    addPatient();
                    const patientId = patient.id;
                    const card = document.querySelector(`[data-patient-id="${patientId}"]`);
                    if (!card) return;
                    
                    Object.keys(patient.data).forEach(key => {
                        if (!key.startsWith('dva_nome_') && !key.startsWith('dva_dose_') && !key.startsWith('antibiotico_nome_') && !key.startsWith('antibiotico_dia_')) {
                            const elem = document.getElementById(key);
                            if (elem) {
                                if (elem.type === 'checkbox') {
                                    elem.checked = patient.data[key];
                                } else {
                                    elem.value = patient.data[key];
                                }
                            }
                        }
                    });
                    
                    const dvaContainer = document.getElementById(`dva_container_${patientId}`);
                    if (dvaContainer) {
                        dvaContainer.innerHTML = `
                            <div class="dva-row" data-dva-id="0">
                                <input type="text" id="dva_nome_0_${patientId}" placeholder="Droga vasoativa" oninput="saveData();" value="${patient.data[`dva_nome_0_${patientId}`] || ''}">
                                <input type="text" id="dva_dose_0_${patientId}" placeholder="Dose (ex: mcg/kg/min)" oninput="saveData();" value="${patient.data[`dva_dose_0_${patientId}`] || ''}">
                                <button class="btn remove-dva-btn" style="display: none;" onclick="removeDva(${patientId}, 0)">üóëÔ∏è</button>
                            </div>
                        `;
                        
                        let maxDvaIndex = 0;
                        Object.keys(patient.data).forEach(key => {
                            if (key.startsWith('dva_nome_') && !key.startsWith('dva_nome_0_')) {
                                const index = parseInt(key.split('_')[2]);
                                maxDvaIndex = Math.max(maxDvaIndex, index);
                                const dvaHtml = `
                                    <div class="dva-row" data-dva-id="${index}">
                                        <input type="text" id="dva_nome_${index}_${patientId}" placeholder="Droga vasoativa" oninput="saveData();" value="${patient.data[`dva_nome_${index}_${patientId}`] || ''}">
                                        <input type="text" id="dva_dose_${index}_${patientId}" placeholder="Dose (ex: mcg/kg/min)" oninput="saveData();" value="${patient.data[`dva_dose_${index}_${patientId}`] || ''}">
                                        <button class="btn remove-dva-btn" onclick="removeDva(${patientId}, ${index})">üóëÔ∏è</button>
                                    </div>
                                `;
                                dvaContainer.insertAdjacentHTML('beforeend', dvaHtml);
                            }
                        });
                        dvaCounters[patientId] = maxDvaIndex;
                    }
                    
                    const antibioticoContainer = document.getElementById(`antibiotico_container_${patientId}`);
                    if (antibioticoContainer) {
                        antibioticoContainer.innerHTML = `
                            <div class="form-row antibiotico-row" data-antibiotico-id="0">
                                <input type="text" id="antibiotico_nome_0_${patientId}" placeholder="Nome do antibi√≥tico" oninput="saveData();" value="${patient.data[`antibiotico_nome_0_${patientId}`] || ''}">
                                <input type="text" id="antibiotico_dia_0_${patientId}" placeholder="Dia de uso (ex: d1, d2)" oninput="saveData();" value="${patient.data[`antibiotico_dia_0_${patientId}`] || ''}">
                                <button class="btn remove-antibiotico-btn" style="display: none;" onclick="removeAntibiotico(${patientId}, 0)">üóëÔ∏è</button>
                            </div>
                        `;
                        
                        let maxIndex = 0;
                        Object.keys(patient.data).forEach(key => {
                            if (key.startsWith('antibiotico_nome_') && !key.startsWith('antibiotico_nome_0_')) {
                                const index = parseInt(key.split('_')[2]);
                                maxIndex = Math.max(maxIndex, index);
                                const html = `
                                    <div class="form-row antibiotico-row" data-antibiotico-id="${index}">
                                        <input type="text" id="antibiotico_nome_${index}_${patientId}" placeholder="Nome do antibi√≥tico" oninput="saveData();" value="${patient.data[`antibiotico_nome_${index}_${patientId}`] || ''}">
                                        <input type="text" id="antibiotico_dia_${index}_${patientId}" placeholder="Dia de uso (ex: d1, d2)" oninput="saveData();" value="${patient.data[`antibiotico_dia_${index}_${patientId}`] || ''}">
                                        <button class="btn remove-antibiotico-btn" onclick="removeAntibiotico(${patientId}, ${index})">üóëÔ∏è</button>
                                    </div>
                                `;
                                antibioticoContainer.insertAdjacentHTML('beforeend', html);
                            }
                        });
                        antibioticoCounters[patientId] = maxIndex;
                    }
                    
                    calculateBalance(patientId);
                    calculateDeltaHGT(patientId);
                    togglePaControls(patientId);
                    toggleDeviceDetails('cvc', patientId);
                    toggleDeviceDetails('avp', patientId);
                    toggleDeviceDetails('linha_arterial', patientId);
                });
                
                if (data.darkMode) {
                    toggleDarkMode(true);
                }
                
                if (data.patients.length > 0) {
                    showTab('pacientes', parseInt(data.patients[0].id));
                } else {
                    addPatient();
                }
            } else {
                addPatient();
            }
        }
        
        function resetAllData() {
            if (!isLoggedIn) return;
            if (confirm('Tem certeza que deseja resetar todos os dados? Isso n√£o pode ser desfeito.')) {
                localStorage.removeItem('utiData');
                location.reload();
            }
        }
        
        function toggleDarkMode(load = false) {
            if (!isLoggedIn) return;
            document.body.classList.toggle('dark-mode');
            const btn = document.getElementById('darkModeToggle');
            btn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Escuro';
            if (!load) saveData();
        }
        
        function resetCalculadoras() {
            if (!isLoggedIn) return;
            const calcInputs = document.querySelectorAll('#calculadoras input, #calculadoras select');
            calcInputs.forEach(input => {
                if (input.type === 'text') {
                    input.value = '';
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                }
            });
            document.getElementById('ckdResult').innerText = '';
            document.getElementById('infusionResult').innerText = '';
            document.getElementById('gcsResult').innerText = '';
            document.getElementById('apacheResult').innerText = '';
        }
        
        function setupCalculadoras() {
            if (!isLoggedIn) return;
            const calcHtml = `
                <h2>Calculadoras M√©dicas</h2>
                <button class="btn btn-reset" onclick="resetCalculadoras()">üóëÔ∏è Zerar Calculadoras</button>

                <button class="btn" onclick="window.open('https://sbn.org.br/medicos/utilidades/calculadoras-nefrologicas/ckd-epi-2021/', '_blank')">üßÆ Calculadora TFG CKD-EPI 2021</button>

                <details>
                    <summary>Conversor Infus√£o (ml/h ‚Üî mcg/kg/min)</summary>
                    <div class="calc-content">
                        <div class="form-group">
                            <label>Modo:</label>
                            <select id="mode"><option value="toMcg">ml/h para mcg/kg/min</option><option value="toMl">mcg/kg/min para ml/h</option></select>
                        </div>
                        <div class="form-group">
                            <label>Dose mcg/kg/min:</label>
                            <input type="text" id="dose" oninput="validateInput(this, 'decimal');">
                        </div>
                        <div class="form-group">
                            <label>Peso (kg):</label>
                            <input type="text" id="weight" oninput="validateInput(this, 'decimal');">
                        </div>
                        <div class="form-group">
                            <label>Concentra√ß√£o (mcg/mL):</label>
                            <input type="text" id="conc" oninput="validateInput(this, 'decimal');">
                        </div>
                        <div class="form-group">
                            <label>Taxa ml/h:</label>
                            <input type="text" id="rate" oninput="validateInput(this, 'decimal');">
                        </div>
                        <button type="button" class="btn" onclick="calcInfusion()">Calcular</button>
                        <p id="infusionResult"></p>
                    </div>
                </details>
                <details>
                    <summary>Glasgow Coma Scale (GCS)</summary>
                    <div class="calc-content">
                        <div class="form-group">
                            <label>Abertura Ocular:</label>
                            <select id="eyes"><option value="4">Espont√¢nea (4)</option><option value="3">√Ä voz (3)</option><option value="2">√Ä dor (2)</option><option value="1">Nenhuma (1)</option></select>
                        </div>
                        <div class="form-group">
                            <label>Resposta Verbal:</label>
                            <select id="verbal"><option value="5">Orientado (5)</option><option value="4">Confuso (4)</option><option value="3">Palavras inadequadas (3)</option><option value="2">Sons incompreens√≠veis (2)</option><option value="1">Nenhuma (1)</option></select>
                        </div>
                        <div class="form-group">
                            <label>Resposta Motora:</label>
                            <select id="motor"><option value="6">Obedece comandos (6)</option><option value="5">Localiza dor (5)</option><option value="4">Retirada √† dor (4)</option><option value="3">Flex√£o anormal (3)</option><option value="2">Extens√£o anormal (2)</option><option value="1">Nenhuma (1)</option></select>
                        </div>
                        <button type="button" class="btn" onclick="calcGCS()">Calcular</button>
                        <p id="gcsResult"></p>
                    </div>
                </details>

                <details>
                    <summary>APACHE II Score</summary>
                    <div class="calc-content">
                        <div class="form-group">
                            <label>Idade:</label>
                            <input type="text" id="apacheAge" oninput="validateInput(this, 'decimal');">
                        </div>
                        <div class="form-group">
                            <label>Temperatura (¬∞C):</label>
                            <input type="text" id="apacheTemp" oninput="validateInput(this, 'decimal');">
                        </div>
                        <div class="form-group">
                            <label>PAM (mmHg):</label>
                            <input type="text" id="apachePam" oninput="validateInput(this, 'decimal');">
                        </div>
                        <div class="form-group">
                            <label>FC (bpm):</label>
                            <input type="text" id="apacheFc" oninput="validateInput(this, 'decimal');">
                        </div>
                        <div class="form-group">
                            <label>FR (rpm):</label>
                            <input type="text" id="apacheFr" oninput="validateInput(this, 'decimal');">
                        </div>
                        <button type="button" class="btn" onclick="calcApache()">Calcular</button>
                        <p id="apacheResult"></p>
                    </div>
                </details>
            `;
            document.getElementById('calculadoras').innerHTML = calcHtml;
        }
        
        function calcInfusion() {
            if (!isLoggedIn) return;
            let mode = document.getElementById('mode').value;
            let weight = parseFloat(document.getElementById('weight').value.replace(',', '.'));
            let conc = parseFloat(document.getElementById('conc').value.replace(',', '.'));
            
            if (isNaN(weight) || isNaN(conc) || weight <= 0 || conc <= 0) {
                document.getElementById('infusionResult').innerText = 'Preencha peso e concentra√ß√£o com valores v√°lidos.';
                return;
            }
            
            if (mode === 'toMcg') {
                let rate = parseFloat(document.getElementById('rate').value.replace(',', '.'));
                if (isNaN(rate) || rate <= 0) {
                    document.getElementById('infusionResult').innerText = 'Preencha taxa ml/h com valor v√°lido.';
                    return;
                }
                let dose = (rate * conc) / (weight * 60);
                document.getElementById('infusionResult').innerText = `Dose: ${dose.toFixed(2)} mcg/kg/min`;
            } else {
                let dose = parseFloat(document.getElementById('dose').value.replace(',', '.'));
                if (isNaN(dose) || dose <= 0) {
                    document.getElementById('infusionResult').innerText = 'Preencha dose mcg/kg/min com valor v√°lido.';
                    return;
                }
                let rate = (dose * weight * 60) / conc;
                document.getElementById('infusionResult').innerText = `Taxa: ${rate.toFixed(2)} ml/h`;
            }
        }
        
        function calcGCS() {
            if (!isLoggedIn) return;
            let eyes = parseInt(document.getElementById('eyes').value);
            let verbal = parseInt(document.getElementById('verbal').value);
            let motor = parseInt(document.getElementById('motor').value);
            if (isNaN(eyes) || isNaN(verbal) || isNaN(motor)) {
                document.getElementById('gcsResult').innerText = 'Selecione todas as op√ß√µes.';
                return;
            }
            let total = eyes + verbal + motor;
            document.getElementById('gcsResult').innerText = `GCS Total: ${total}`;
        }
        
        function calcSOFA(patientId) {
            if (!isLoggedIn) return;
            let resp = parseFloat(getValue(`sofa_resp_${patientId}`).replace(',', '.'));
            let plat = parseFloat(getValue(`sofa_plat_${patientId}`).replace(',', '.'));
            let bili = parseFloat(getValue(`sofa_bili_${patientId}`).replace(',', '.'));
            let cv = parseFloat(getValue(`sofa_cv_${patientId}`).replace(',', '.'));
            let gcs = parseFloat(getValue(`sofa_gcs_${patientId}`).replace(',', '.'));
            let renal = parseFloat(getValue(`sofa_renal_${patientId}`).replace(',', '.'));
            
            if (isNaN(resp) || isNaN(plat) || isNaN(bili) || isNaN(cv) || isNaN(gcs) || isNaN(renal)) {
                document.getElementById(`sofaResult_${patientId}`).innerText = 'Preencha todos os campos com valores v√°lidos.';
                return;
            }
            
            let scoreResp = 0;
            if (resp < 100) scoreResp = 4;
            else if (resp < 200) scoreResp = 3;
            else if (resp < 300) scoreResp = 2;
            else if (resp < 400) scoreResp = 1;
            
            let scorePlat = 0;
            if (plat < 20) scorePlat = 4;
            else if (plat < 50) scorePlat = 3;
            else if (plat < 100) scorePlat = 2;
            else if (plat < 150) scorePlat = 1;
            
            let scoreBili = 0;
            if (bili >= 12) scoreBili = 4;
            else if (bili >= 6) scoreBili = 3;
            else if (bili >= 2) scoreBili = 2;
            else if (bili >= 1.2) scoreBili = 1;
            
            let scoreCv = 0;
            if (cv > 15 || cv > 0.1) scoreCv = 4;
            else if (cv >= 5 || cv <= 0.1) scoreCv = 3;
            else if (cv > 0) scoreCv = 2;
            else if (cv < 70) scoreCv = 1;
            
            let scoreGcs = 0;
            if (gcs < 6) scoreGcs = 4;
            else if (gcs < 10) scoreGcs = 3;
            else if (gcs < 13) scoreGcs = 2;
            else if (gcs < 15) scoreGcs = 1;
            
            let scoreRenal = 0;
            if (renal >= 5 || renal < 200) scoreRenal = 4;
            else if (renal >= 3.5 || renal < 500) scoreRenal = 3;
            else if (renal >= 2) scoreRenal = 2;
            else if (renal >= 1.2) scoreRenal = 1;
            
            let total = scoreResp + scorePlat + scoreBili + scoreCv + scoreGcs + scoreRenal;
            document.getElementById(`sofaResult_${patientId}`).innerText = `SOFA Total: ${total} (Resp: ${scoreResp}, Plat: ${scorePlat}, Bili: ${scoreBili}, CV: ${scoreCv}, GCS: ${scoreGcs}, Renal: ${scoreRenal})`;
        }
        
        function calcApache() {
            if (!isLoggedIn) return;
            let age = parseFloat(document.getElementById('apacheAge').value.replace(',', '.'));
            let temp = parseFloat(document.getElementById('apacheTemp').value.replace(',', '.'));
            let pam = parseFloat(document.getElementById('apachePam').value.replace(',', '.'));
            let fc = parseFloat(document.getElementById('apacheFc').value.replace(',', '.'));
            let fr = parseFloat(document.getElementById('apacheFr').value.replace(',', '.'));
            
            if (isNaN(age) || isNaN(temp) || isNaN(pam) || isNaN(fc) || isNaN(fr)) {
                document.getElementById('apacheResult').innerText = 'Preencha todos os campos com valores v√°lidos.';
                return;
            }
            
            let score = 0;
            if (age >= 75) score += 6;
            else if (age >= 65) score += 5;
            else if (age >= 55) score += 3;
            else if (age >= 45) score += 2;
            
            if (temp >= 41 || temp < 30) score += 4;
            else if (temp >= 39 || temp < 32) score += 3;
            else if (temp >= 38.5 || temp < 34) score += 1;
            
            if (pam >= 160 || pam < 50) score += 4;
            else if (pam >= 130 || pam < 70) score += 3;
            else if (pam < 110) score += 2;
            
            if (fc >= 180 || fc < 40) score += 4;
            else if (fc >= 140 || fc < 55) score += 3;
            else if (fc >= 110 || fc < 70) score += 2;
            
            if (fr >= 50 || fr < 6) score += 4;
            else if (fr >= 35 || fr < 10) score += 3;
            else if (fr >= 25 || fr < 12) score += 1;
            
            document.getElementById('apacheResult').innerText = `APACHE II: ${score} (simplificado)`;
        }
    </script>
</body>
</html>